# Picasso A100 40GB hardware overrides
# Merged on top of: picasso/base.yaml -> configs/train_meanflow.yaml -> this file
#
# Only contains hardware-specific values that DIFFER from configs/train_meanflow.yaml.
# Architecture choices (prediction_type, conditioning_mode, jvp_strategy, etc.)
# are set in the base config and inherited here.
#
# Hardware: A100-SXM4-40GB, 6 GPUs per job (within one DGX node)
# UNet: 178M params, ~6 GB fixed (params doubled during JVP + optimizer + grads)
# Latent: (B, 4, 48, 48, 48) = 0.88 MB/sample in bf16
#
# Memory budget per GPU (40 GB, exact JVP, no gradient checkpointing):
#   Fixed: ~6 GB (params doubled during JVP + optimizer + grads)
#   Activations: ~20 GB at batch_size=2 (batch_size=4 OOMs)
#   Headroom: ~14 GB
#
# Effective batch = batch_size x devices x accumulate = 2 x 6 x 11 = 132 (~128)
# ~5,500 train scans -> ~41 steps/epoch -> ~61,500 total steps at 1500 epochs

# --- Picasso paths ---
paths:
  latents_dir: "${paths.results_root}/latents"
  checkpoints_dir: "${paths.results_root}/training_checkpoints"
  logs_dir: "${paths.results_root}/phase_4/logs"
  samples_dir: "${paths.results_root}/phase_4/samples"
  diagnostics_dir: "${paths.results_root}/phase_4/diagnostics"
  maisi_vae_weights: "${paths.checkpoints_root}/NV-Generate-MR/models/autoencoder_v2.pt"

# --- Multi-GPU DDP: 6 A100s ---
trainer:
  devices: 6
  strategy: ddp
  accelerator: gpu

# --- Training: hardware-specific overrides ---
training:
  batch_size: 2                      # per-GPU; exact JVP limits to 2 on A100 40GB
  num_workers: 16                    # 128 cores / 8 GPUs = 16 per GPU
  prefetch_factor: 4
  accumulate_grad_batches: 11        # effective batch = 2 x 6 x 11 = 132
  log_every_n_steps: 10              # ~41 steps/epoch -> log ~every 4 epochs
  augmentation:
    enabled: true                    # critical for 1500 epochs on ~5.5K samples

# --- Diagnostics: always on for Picasso runs ---
diagnostics:
  enabled: true

# --- Evaluation: enable with Picasso paths ---
evaluation:
  enabled: true
  fid_weights_path: "${paths.checkpoints_root}/fid_weights/radimagenet_resnet50.pt"

# --- VAE: A100 can decode without memory splits ---
vae:
  norm_float16: true
  num_splits: 1
