#!/bin/bash
set -e  # Exit immediately if a command exits with a non-zero status.

# Define the target directory
EXTERNAL_DIR="src/external"

# Ensure the target directory exists
mkdir -p "$EXTERNAL_DIR"

# --- Function to vendor a repository ---
vendor_repo() {
    local url=$1
    local dir_name=$2
    local friendly_name=$3
    
    echo "------------------------------------------------"
    echo "Vendoring $friendly_name..."
    
    # Define temporary and target paths
    local temp_path="temp_${dir_name}"
    local final_path="${EXTERNAL_DIR}/${dir_name}"

    # Clean up any previous attempts
    rm -rf "$temp_path"
    rm -rf "$final_path"

    # 1. Clone to a temporary location
    git clone --depth 1 "$url" "$temp_path"

    # 2. Capture the commit hash
    local commit_hash=$(cd "$temp_path" && git log -1 --format="%H")
    local commit_date=$(cd "$temp_path" && git log -1 --format="%ad" --date=iso)
    echo "Pinned at commit: $commit_hash ($commit_date)"

    # 3. Remove the .git folder (Critical for "vendoring")
    rm -rf "$temp_path/.git"

    # 4. Move to src/external/
    mv "$temp_path" "$final_path"

    # 5. Create __init__.py to make it importable/discoverable
    touch "$final_path/__init__.py"

    # 6. Append info to the README content buffer
    # We use a global variable to accumulate README content
    README_CONTENT="${README_CONTENT}
## ${friendly_name}
- **Source:** ${url}
- **Commit:** \`${commit_hash}\`
- **Date:** ${commit_date}
- **Local Modifications:** Removed \`.git\` folder, added \`__init__.py\`.
"
}

# --- Initialize README Content ---
README_CONTENT="# External Dependencies
*Auto-generated by vendor_deps.sh on $(date)*

This directory contains vendored copies of external reference repositories. 
These are static snapshots used for stability and reproducibility.

"

# --- 1. MeanFlow (JAX/Original) ---
vendor_repo "https://github.com/Gsunshine/meanflow.git" "MeanFlow" "MeanFlow (JAX/Original)"

# --- 2. MeanFlow-PyTorch ---
vendor_repo "https://github.com/HaoyiZhu/MeanFlow-PyTorch.git" "MeanFlow-PyTorch" "MeanFlow-PyTorch"

# --- 3. NV-Generate-CTMR (NVIDIA Medical Image Generation) ---
vendor_repo "https://github.com/NVIDIA-Medtech/NV-Generate-CTMR.git" "NV-Generate-CTMR" "NV-Generate-CTMR"

# --- 4. MOTFM (Baseline) ---
vendor_repo "https://github.com/milad1378yz/MOTFM.git" "MOTFM" "MOTFM (Baseline)"

# --- Finalize ---

# Create the top-level __init__.py for src/external
touch "$EXTERNAL_DIR/__init__.py"

# Write the collected metadata to README_EXTERNAL.md
echo "$README_CONTENT" > "$EXTERNAL_DIR/README_EXTERNAL.md"

echo "------------------------------------------------"
echo "âœ… Success! All dependencies vendored into $EXTERNAL_DIR"
echo "   - MeanFlow/           (JAX/Original reference)"
echo "   - MeanFlow-PyTorch/   (PyTorch implementation)"
echo "   - NV-Generate-CTMR/   (NVIDIA medical image generation)"
echo "   - MOTFM/              (Baseline)"
echo "   - README_EXTERNAL.md updated."